# 제조 공정 시뮬레이션 엔진 구조 설명서

## 🎯 시뮬레이션 엔진이란?

제조 공정 시뮬레이션 엔진은 **가상의 공장**을 컴퓨터 안에서 돌려보는 프로그램입니다. 
마치 게임처럼 제품이 여러 공정을 거쳐 완성되는 과정을 시뮬레이션할 수 있습니다.

### 핵심 개념
- **엔티티(Entity)**: 공장에서 만들어지는 제품 하나하나
- **블록(Block)**: 공장의 각 작업 공정 (예: 투입구, 가공기, 배출구)
- **커넥터(Connector)**: 블록의 입구와 출구
- **파이프(Pipe)**: 블록과 블록을 연결하는 통로
- **신호(Signal)**: 공정 간의 소통 수단 (예: "준비됐어요", "보내주세요")

## 📊 시스템 구조

### 1. 전체 구조도
```
사용자 인터페이스 (Vue.js)
        ↓↑
    API 서버 (FastAPI)
        ↓↑
  시뮬레이션 엔진 (SimPy)
        ↓↑
    각종 관리자들
```

### 2. 핵심 관리자들

시뮬레이션 엔진은 여러 "관리자"들이 협력하여 작동합니다:

#### 🏭 블록 프로세서 (Block Processor)
- **역할**: 각 블록(공정)에서 일어나는 작업을 처리
- **동작**: 
  - 제품이 블록에 도착하면 받아들임
  - 정해진 작업(액션)을 수행
  - 다음 블록으로 제품을 보냄

#### 📦 엔티티 매니저 (Entity Manager)
- **역할**: 제품(엔티티)의 생성과 소멸 관리
- **동작**:
  - 새 제품 생성
  - 제품 위치 추적
  - 제품이 어디로 가는지 기록
  - 완성된 제품 제거

#### 🚦 신호 매니저 (Signal Manager)
- **역할**: 블록 간의 신호 통신 관리
- **동작**:
  - "공정1 준비 완료" 같은 신호 저장
  - 다른 블록이 신호를 확인할 수 있게 함
  - 신호가 바뀔 때까지 대기 기능

#### 🔗 파이프 매니저 (Pipe Manager)
- **역할**: 블록 간의 연결 통로 관리
- **동작**:
  - 어느 블록이 어디로 연결되는지 기록
  - 제품이 통로를 통해 이동하도록 함
  - 여러 개의 연결도 지원

#### 🏁 소스 매니저 (Source Manager)
- **역할**: 제품을 생성하는 시작점 관리
- **동작**:
  - 일정 간격으로 새 제품 생성
  - 생성 조건 확인 (예: 신호가 true일 때만)

#### 🎬 액션 실행기 (Action Executor)
- **역할**: 각종 동작 명령 실행
- **동작 종류**:
  - `delay`: 일정 시간 대기
  - `signal_update`: 신호 변경
  - `route_to_connector`: 다음 블록으로 이동
  - `custom_sink`: 제품 완성 처리

#### 📜 스크립트 실행기 (Script Executor)
- **역할**: 복잡한 조건부 동작 실행
- **스크립트 예시**:
  ```
  if 공정1 준비완료 = true
      공정1 준비완료 = false
      go to 공정1.입구
  ```

## 🔄 시뮬레이션 동작 과정

### 1. 시작
1. 사용자가 공정 설계를 완료하고 "시작" 버튼 클릭
2. 시뮬레이션 엔진이 설계도를 받아 가상 공장 구성

### 2. 제품 생성
1. 소스 블록(투입구)에서 제품 생성
2. 제품에 고유 번호 부여 (예: 투입-1, 투입-2)

### 3. 제품 이동
1. 제품이 현재 블록에서 작업 수행
2. 다음 블록으로 이동할 준비 완료
3. 연결된 파이프를 통해 이동
4. **이동 중(Transit)** 상태로 표시

### 4. 병렬 처리
여러 제품이 동시에 다른 공정에서 작업 가능:
- 공정1에서 제품A 가공 중
- 공정2에서 제품B 가공 중
- 공정3에서 제품C 가공 중

### 5. 신호 제어
블록 간 협업을 위한 신호 시스템:
- "공정1이 비었어요" → 새 제품 보내기
- "공정2가 꽉 찼어요" → 대기하기

### 6. 완료
제품이 배출구에 도착하면 완성품으로 처리

## 🚀 성능 최적화

### 디버그 모드
- **일반 모드**: 초당 22,000개 이상 처리 (매우 빠름)
- **디버그 모드**: 초당 1,000개 처리 (상세 기록 남김)

### 캐싱 시스템
자주 사용하는 정보를 기억해두어 속도 향상:
- 시뮬레이션 설정 캐싱
- 엔티티 상태 캐싱
- 연결 정보 캐싱

## 💡 주요 특징

### 1. 동적 구성
- 블록 이름, 신호 이름을 자유롭게 설정 가능
- 하드코딩 없이 유연한 구성

### 2. 실시간 모니터링
- 제품 위치 실시간 추적
- 신호 상태 실시간 확인
- 처리량 실시간 표시

### 3. 용량 관리
- 각 블록의 최대 수용량 설정
- 이동 중인 제품도 용량 계산에 포함
- 과부하 방지

### 4. 조건부 라우팅
스크립트를 통한 복잡한 조건 처리:
```
wait 신호1 = true or 신호2 = true
if 조건 = true
    동작 수행
```

## 📋 파일 구조

```
backend/app/core/
├── block_processor.py    # 블록 작업 처리
├── entity_manager.py     # 제품 관리
├── signal_manager.py     # 신호 통신
├── pipe_manager.py       # 연결 관리
├── source_manager.py     # 제품 생성
├── action_executor.py    # 동작 실행
├── script_executor.py    # 스크립트 실행
└── monitoring.py         # 모니터링
```

## 🔧 설정 가능한 항목

### 블록 설정
- 이름
- 최대 수용량
- 커넥터 (입구/출구)
- 실행할 액션들

### 액션 설정
- 대기 시간
- 신호 변경
- 이동 경로
- 조건부 동작

### 신호 설정
- 신호 이름
- 초기값 (true/false)
- 실시간 변경 가능

## 🎮 사용 예시

### 간단한 3단계 공정
1. **투입**: 제품 생성 → 공정1로 이동
2. **공정1**: 3초 가공 → 공정2로 이동
3. **공정2**: 5초 가공 → 배출로 이동
4. **배출**: 완성품 처리

### 병렬 공정 (분기)
1. **투입**: 제품 생성
2. **분기 결정**:
   - 조건 A → 공정A로
   - 조건 B → 공정B로
3. **합류**: 두 공정 모두 배출로

## 📈 모니터링 정보

시뮬레이션 중 확인 가능한 정보:
- 현재 시간
- 처리된 제품 수
- 각 블록의 제품 수
- 이동 중인 제품
- 신호 상태
- 초당 처리 속도

## 🛠️ 문제 해결

### 제품이 막히는 경우
- 블록 용량 확인
- 신호 조건 확인
- 연결 상태 확인

### 속도가 느린 경우
- 디버그 모드 끄기
- 불필요한 로깅 제거
- 캐시 활용

### 예상과 다른 동작
- 스크립트 문법 확인
- 신호 이름 정확성 확인
- 연결 설정 확인

## 📝 요약

제조 공정 시뮬레이션 엔진은:
1. **가상의 공장**을 컴퓨터에서 실행
2. **여러 관리자**가 협력하여 작동
3. **실시간**으로 제품 흐름 시뮬레이션
4. **유연한 설정**으로 다양한 공정 구현 가능
5. **고성능**으로 빠른 시뮬레이션 실행

이 시스템을 통해 실제 공장을 만들기 전에 미리 테스트하고 최적화할 수 있습니다.