# 시뮬레이션 업데이트 검토 결과

## 개요
실제 현장 공정 시뮬레이션을 위한 16개 항목의 업데이트 사항에 대한 기술적 검토 결과입니다.
각 항목별로 구현 난이도와 기존 코드 훼손 위험성을 평가하였습니다.

### 평가 기준
- **난이도**: ⭐(매우 쉬움) ~ ⭐⭐⭐⭐⭐(매우 어려움)
- **위험성**: 🟢(낮음) ~ 🔴(높음)

---

## 상세 검토 결과

### 1. 연결점 위치 이동 기능 ✅ **완료 (2025-06-04)**
- **난이도**: ⭐⭐⭐
- **위험성**: 🟡 (중간)
- **주요 작업**:
  - Konva.js에서 커넥터 드래그 이벤트 처리
  - 블록 경계 내 이동 제한 로직
  - 연결된 선 실시간 업데이트
- **위험 요소**: 기존 커넥터 클릭 이벤트와 충돌 가능성
- **구현 내용**:
  - 수동 드래그 시스템으로 premature drag end 문제 해결
  - 블록 내 자유 드래그 및 자석 효과로 가장자리 스냅 구현
  - 임시 위치 저장으로 props 업데이트 대기 중 위치 유지
  - 드래그 핸들(파란 점선)과 커넥터 동기화 완료
  - 이벤트 리스너 정리로 중복 실행 방지
- **커밋**: 1df58cc "feat(ui): 커넥터 드래그 기능 완전 구현"

### 2. 연결점 추가/삭제 기능 // 적용 완료
- **난이도**: ⭐⭐⭐⭐
- **위험성**: 🟡 (중간)
- **주요 작업**:
  - 동적 커넥터 생성/삭제 UI
  - Backend에서 새 커넥터 인식
  - 스크립트의 go to 명령어와 연동
- **위험 요소**: 기존 커넥터 관리 로직 수정 필요

### 3. 엔티티 속성 추가 // 적용 완료
- **난이도**: ⭐⭐⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - 엔티티에 custom 속성 필드 추가
  - 색상 변경 로직 (5가지 색상 + 기본)
  - `product type +=/-=` 명령어 구현
  - 조건문에서 속성 체크 (and/or 지원)
- **위험 요소**: 기존 엔티티 구조에 필드 추가만 하면 되므로 안전

### 4. if 조건부 AND 타입 추가 // 적용 완료
- **난이도**: ⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - 기존 OR 조건 함수에 AND 로직 추가
  - 스크립트 파서 수정
- **위험 요소**: 기존 조건문 로직 확장이므로 안전

### 5. wait 명령어 OR/AND 추가 // 적용 완료
- **난이도**: ⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - wait 명령어 파서 수정
  - 복합 조건 평가 로직
- **위험 요소**: 4번과 동일하게 안전

### 6. int 타입 전역 변수 ✅ **완료 (2025-06-06)**
- **난이도**: ⭐⭐⭐⭐
- **위험성**: 🟢 (낮음) *모듈화 적용 시*
- **주요 작업**:
  - 신호 관리자에 int 타입 지원
  - 산술 연산 명령어 (`int 변수 += 1`)
  - 비교 연산자 지원 (`if 변수 > 10`)
  - UI에서 타입 선택 기능
- **위험 요소**: ~~기존 boolean 전용 신호 시스템 확장 필요~~ → 별도 모듈로 안전하게 구현 가능
- **구현 내용**:
  - `IntegerVariableManager` 클래스로 정수 변수 별도 관리
  - `UnifiedVariableAccessor`로 boolean/integer 통합 접근
  - 산술 연산: `+=`, `-=`, `*=`, `/=` 완전 지원
  - 비교 연산: `>`, `<`, `>=`, `<=`, `=`, `!=` 지원
  - 전역 신호 패널에서 타입 선택 드롭다운 추가
  - 스크립트 검증 및 에디터 하이라이팅 지원
  - log 명령어에서 변수 보간: `log "count: {변수명}"`

### 7. 투입 블록 전용 명령어 // 적용 완료 create entity
- **난이도**: ⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - `product create` 명령어 추가
  - Source 블록에서만 실행 가능하도록 제한
- **위험 요소**: 새 명령어 추가이므로 안전

### 8. 배출 블록 전용 명령어 // 적용 완료 dispose entity
- **난이도**: ⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - `product destroy` 명령어 추가
  - Sink 블록에서만 실행 가능하도록 제한
- **위험 요소**: 7번과 동일하게 안전

### 9. 각 배출 블록 배출량 표시 ✅ **완료 (2025-01-07)**
- **난이도**: ⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - Sink 블록별 카운터 추가
  - UI에 텍스트 표시
- **위험 요소**: 표시 기능만 추가하므로 매우 안전
- **구현 내용**:
  - 모든 블록에서 `total_processed` 카운터 활용
  - `dispose entity` 명령으로 제거된 엔티티 자동 카운트
  - 블록 하단 외부에 "처리: X" 형태로 표시 (녹색)
  - 실시간 업데이트 지원

### 10. 캔버스 정보 텍스트 ✅ **완료 (2025-01-07)**
- **난이도**: ⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - 고정 위치 텍스트 레이어
  - 텍스트 편집 UI (크기, 굵기 조정)
  - JSON 저장/로드
  - 가볍고 구현이 간단한 텍스트 편집기 라이브러리 사용하여 텍스트 편집할 수 있도록 개발(텍스트 크기, 굵기, 색상 등만 조정할 예정) // 유저 입력 부분
- **위험 요소**: 독립적인 기능이므로 안전
- **구현 내용**:
  - 캔버스 상단에 고정 위치 정보 텍스트 패널
  - 클릭으로 최소화/확대 토글 (최소화 시 첫 줄만 표시)
  - 확대 시 투명 배경으로 캔버스 가시성 유지
  - 리치 텍스트 편집기 구현 (라이브러리 없이 자체 구현)
  - 선택한 텍스트만 스타일 적용 가능 (굵게, 색상, 크기)
  - 제어판 및 블록 설정창에 따른 반응형 위치 조정
  - JSON 파일에 저장/로드 지원

### 11. 스텝 실행 간격 조정 모드
- **난이도**: ⭐⭐⭐⭐
- **위험성**: 🟡 (중간) *모듈화 적용 시*
- **주요 작업**:
  - 시간 스텝 모드: 고정 시간 간격
  - 이벤트 스텝 모드: 이벤트 완료 후 스텝
  - ~~엔진 코어 로직 수정~~ → 모드별 독립 모듈 추가
- **위험 요소**: ~~시뮬레이션 엔진 핵심 로직 변경 필요~~ → 기존 엔진 유지하고 모듈 추가로 안전

### 12. 블록 상태 속성
- **난이도**: ⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - `블록명 status = "running"` 명령어
  - 블록에 status 필드 추가
- **위험 요소**: 단순 속성 추가이므로 안전

### 13. 블록 정보 화면 표시
- **난이도**: ⭐⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - 평균 처리 시간 계산
  - 블록 옆 텍스트 표시
  - 활성화/비활성화 토글
- **위험 요소**: 표시 기능이므로 안전

### 14. 레이어 순서 조정
- **난이도**: ⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - Konva 레이어 z-index 조정
  - 선 → 블록 → 커넥터 순서
- **위험 요소**: 시각적 변경만이므로 매우 안전

### 15. 시뮬레이션 로그 명령어 // log 스크립트는 존재 이를 웹페이지에서 볼수 있도록 구현 필요
- **난이도**: ⭐⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - `log "메시지 {변수}"` 명령어
  - 변수 치환 로직
  - 웹 UI에서 로그 조회
- **위험 요소**: 새 기능 추가이므로 안전
- **사용자 추가 내용**: 현재 스크립트에 로그 명령이 추가 되어 있음, 해당 로그는 백엔드 서버 콘솔로그에만 표기, 해당 명령을 사용하여 웹페이지에서 볼 수 있도록 구현(다른 백엔드 로그는 웹페이지에서 볼수 없고 스크립트 log 명령으로 된 부분만 로깅)

### 16. 브레이크포인트 기능
- **난이도**: ⭐⭐⭐⭐⭐
- **위험성**: 🟡 (중간)
- **주요 작업**:
  - 스크립트 편집기에 브레이크포인트 UI
  - 엔진에서 실행 중단/재개 로직
  - 디버그 상태 표시
- **위험 요소**: 엔진 실행 흐름 제어 추가 필요

---

## 우선순위 및 구현 전략

### 1단계: 안전하고 쉬운 기능 (위험성 🟢, 난이도 ⭐~⭐⭐)
1. 레이어 순서 조정 (#14)
2. 각 배출 블록 배출량 표시 (#9)
3. 투입/배출 블록 전용 명령어 (#7, #8)
4. 블록 상태 속성 (#12)
5. 캔버스 정보 텍스트 (#10)

### 2단계: 중간 난이도 기능 (위험성 🟢~🟡, 난이도 ⭐⭐~⭐⭐⭐)
6. if/wait 조건부 AND 추가 (#4, #5)
7. 시뮬레이션 로그 명령어 (#15)
8. 블록 정보 화면 표시 (#13)
9. ~~연결점 위치 이동 (#1)~~ ✅ **완료**
10. 엔티티 속성 추가 (#3)
11. int 타입 전역 변수 (#6) *모듈화로 위험성 감소*

### 3단계: 복잡한 기능 (위험성 🟡, 난이도 ⭐⭐⭐⭐~⭐⭐⭐⭐⭐)
12. 연결점 추가/삭제 (#2)
13. 브레이크포인트 기능 (#16)
14. 스텝 실행 간격 조정 모드 (#11)
    - **개선된 구현 방안**: 모드별 독립 모듈
      - 기본 모드: 현재 엔진 코드 유지
      - 시간 스텝 모드: TimeStepModule (신규)
      - 이벤트 스텝 모드: EventStepModule (신규)
    - **위험성 개선**: 🔴 → 🟡 (기존 엔진 수정 불필요)
    - **구현 예시**:
      ```python
      def set_step_mode(self, mode: str):
          if mode == "default":
              self.step_handler = self._default_step
          elif mode == "time":
              self.step_handler = TimeStepModule(interval)
          elif mode == "event":
              self.step_handler = EventStepModule()
      ```

---

## 구현 시 주의사항

1. **모듈화**: 각 기능을 독립적인 모듈로 구현하여 기존 코드 영향 최소화
2. **테스트**: 각 기능 구현 후 기존 시뮬레이션 동작 테스트 필수
3. **백업**: 주요 변경 전 현재 작동 코드 백업
4. **점진적 통합**: 한 번에 하나씩 기능 추가 및 검증

## 추가 제안사항 상세 계획

### 1. 스크립트 명령어 도움말 기능
- **난이도**: ⭐⭐⭐
- **위험성**: 🟢 (낮음)
- **구현 방안**:
  - 스크립트 편집기에 툴팁 컴포넌트 추가
  - 명령어별 도움말 데이터베이스 구축
  - 커서 위치 기반 컨텍스트 도움말 표시
- **도움말 내용 예시**:
  ```
  delay [숫자] - 지정된 시간(초) 동안 대기
  wait [신호명] = [값] - 신호가 지정값이 될 때까지 대기
  go to [블록명].[커넥터명],[시간] - 다른 블록으로 이동
  product type += [속성](색상) - 엔티티 속성 추가
  int [변수명] += [값] - 정수 변수에 값 더하기
  ```
- **우선순위**: 2단계 후반부 구현 권장

### 2. 명령어 자동완성 기능
- **난이도**: ⭐⭐⭐⭐
- **위험성**: 🟢 (낮음)
- **구현 방안**:
  - CodeMirror 코드 편집기 라이브러리 활용
  - 현재 컨텍스트 기반 자동완성 제안
  - 명령어, 블록명, 신호명, 변수명 자동완성 지원
  - 오류 문맥 체크 기능 // 사용자 입력 부분
- **자동완성 범위**:
  - 기본 명령어: delay, wait, if, go to, jump to 등
  - 동적 데이터: 현재 블록명, 커넥터명, 신호명, 변수명
  - 스니펫: 자주 사용하는 패턴 (예: wait-if-go to 조합)
- **구현 예시**:
  ```javascript
  // 사용자가 "go " 입력 시
  suggestions: [
    { label: "go to", insertText: "go to ${1:블록명}.${2:커넥터명},${3:시간}" }
  ]
  ```
- **우선순위**: 3단계 구현 권장 (복잡도 높음)

### 3. 변경사항 되돌리기 (Undo/Redo)
- **난이도**: ⭐⭐⭐⭐⭐
- **위험성**: 🟡 (중간)
- **구현 방안**:
  - Command Pattern 사용한 작업 이력 관리
  - 각 변경 작업을 되돌릴 수 있는 역연산 정의
  - 전역 Undo/Redo 스택 관리
- **지원 범위**:
  - 블록 추가/삭제/이동
  - 연결선 추가/삭제
  - 속성 변경 (스크립트, 설정값)
  - 전역 신호/변수 생성/삭제
- **구현 구조**:
  ```javascript
  class UndoManager {
    history: Command[] = []
    currentIndex: number = -1
    
    execute(command: Command) {
      command.execute()
      this.history.splice(this.currentIndex + 1)
      this.history.push(command)
      this.currentIndex++
    }
    
    undo() {
      if (this.currentIndex >= 0) {
        this.history[this.currentIndex].undo()
        this.currentIndex--
      }
    }
  }
  ```
- **제한사항**: 시뮬레이션 실행 중에는 Undo 비활성화
- **우선순위**: 3단계 후반부 구현 권장

## 모듈화 적용 후 개선 사항

사용자의 제안을 반영하여 다음과 같이 개선되었습니다:

1. **int 타입 전역 변수 (#6)**
   - 3계층 모듈 구조로 기존 코드 영향 없이 구현 가능
   - 위험성: 🟡 → 🟢
   - 2단계로 우선순위 상향 조정

2. **스텝 실행 간격 조정 모드 (#11)**
   - 모드별 독립 모듈로 기존 엔진 보존
   - 위험성: 🔴 → 🟡
   - 더 안전한 구현 가능

## 전체 구현 로드맵

### Phase 1: 기반 구축 (1-2주)
- 1단계 기능 5개 구현
- 기본 기능 안정화

### Phase 2: 핵심 기능 확장 (2-3주)
- 2단계 기능 11개 구현
- 스크립트 도움말 기능 추가

### Phase 3: 고급 기능 (3-4주)
- 3단계 기능 3개 구현
- 자동완성 및 Undo/Redo 기능

총 예상 기간: 6-9주

## 추가 구현 완료 항목

### 17. if 블록 시각 표현 ✅ **완료 (2025-06-06)**
- **난이도**: ⭐⭐⭐
- **위험성**: 🟢 (낮음)
- **주요 작업**:
  - 스크립트 편집기에서 if 블록과 들여쓰기된 내용 시각적 구분
  - if 문 라인 하이라이팅 (파란색 배경 + 왼쪽 테두리)
  - 들여쓰기된 블록 라인 하이라이팅 (연한 파란색 배경)
- **구현 내용**:
  - SimpleHighlighter.js에 if 블록 감지 로직 통합
  - Line decoration으로 if 문과 들여쓰기 블록 구분
  - 중첩 if 블록 지원
  - 탭, 4 스페이스, 2 스페이스 들여쓰기 모두 지원
- **기술적 특징**:
  - 기존 하이라이터와 완전 통합
  - 별도 의존성 없음
  - 실시간 업데이트 지원

이 검토 결과를 바탕으로 안전하고 효율적인 업데이트를 진행할 수 있을 것입니다.